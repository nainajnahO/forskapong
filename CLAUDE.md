# CLAUDE.md

## Project Overview

Forskåpong is a Swedish beer pong tournament website for an annual event in Uppsala, Sweden. It serves as both a marketing landing page and a live tournament management system with real-time Swiss-system pairings and knockout brackets.

**Tech stack:** React 19 + TypeScript + Vite 7 + Tailwind CSS 3.4 + Supabase + Three.js + Mapbox GL

## Commands

```bash
npm run dev          # Start dev server (Vite)
npm run build        # Type-check (tsc -b) then build for production
npm run type-check   # TypeScript type-check only (tsc -b --noEmit)
npm run lint         # ESLint on all .ts/.tsx files
npm run format       # Prettier format src/
npm run format:check # Prettier check src/
npm run test         # Run tests once (vitest run)
npm run test:watch   # Run tests in watch mode
```

## Project Structure

```
src/
├── main.tsx                     # Entry point: React root + ThemeProvider
├── App.tsx                      # Router: BrowserRouter with all routes
├── index.css                    # Global CSS: Tailwind, OKLCH tokens, HDR fills
├── components/
│   ├── index.ts                 # Barrel exports for common components
│   ├── common/                  # Reusable components (Container, Card, SectionHeader, ErrorBoundary, 3D canvas wrappers)
│   ├── layout/                  # Navbar, Footer
│   ├── sections/                # Landing page sections (Hero, About, ExplodedView, VenueMap, Sponsors, TicketsComingSoon)
│   │   └── schedule/            # Schedule section with login form, timeline, scroll hooks
│   ├── ui/                      # Low-level UI primitives (avatar, Particles, WarpSpeedCanvas)
│   └── animate-ui/              # Motion animation primitives (spring, tooltip, slot, avatar-group)
├── pages/
│   ├── Play.tsx                 # Team code entry (6-char: 3 letters + 3 digits)
│   ├── Dashboard.tsx            # Team dashboard after login
│   ├── MatchPage.tsx            # Individual match view
│   ├── Scoreboard.tsx           # Public scoreboard
│   ├── DisplayPage.tsx          # Chrome-free display (no navbar/footer)
│   └── admin/
│       ├── AdminPage.tsx        # Admin panel with passphrase gate
│       ├── AdminPassphraseGate.tsx
│       ├── tabs/                # LiveTab, TeamsTab, TournamentTab, SimulatorTab
│       ├── components/          # Admin-specific components (bracket views, modals, editors)
│       └── lib/                 # Admin utility functions (match-utils)
├── contexts/
│   ├── ThemeContext.tsx          # Theme provider (always dark, with background variant toggle: fluid/framer)
│   ├── ThemeContextDef.ts       # Context definition
│   ├── AdminTabContext.tsx       # Admin tab state provider
│   ├── AdminTabContextDef.ts    # Context definition
│   ├── useTheme.ts              # Theme hook
│   └── useAdminTab.ts           # Admin tab hook
├── hooks/                       # Custom hooks (useScrollState, useIsVisible, useTypewriter, useViewportWidth, etc.)
├── lib/
│   ├── constants.ts             # All event config, nav links, schedule data, 3D camera waypoints, map config
│   ├── database.types.ts        # Supabase generated types (teams, matches, tournament tables)
│   ├── supabase.ts              # Supabase client init (requires VITE_SUPABASE_URL + VITE_SUPABASE_ANON_KEY)
│   ├── tournament-engine.ts     # Swiss pairing, knockout bracket, rankings (Buchholz tiebreaker)
│   ├── tournament-engine.test.ts # Vitest tests for tournament logic
│   ├── simulator.ts             # Tournament simulation engine (batch sim, skill bias, verification stats)
│   ├── theme-utils.ts           # Theme-aware class helpers (themeBg, themeText, themeBorder)
│   ├── utils.ts                 # cn() utility (clsx + tailwind-merge)
│   └── warpspeed.ts             # Starfield canvas animation (ported from adolfintel/warpspeed)
├── types/
│   └── index.ts                 # Shared TypeScript interfaces (ScheduleEvent, NavLink, CameraWaypoint, etc.)
├── assets/
│   └── hdr/                     # PQ-encoded AVIF images for HDR displays (generated by scripts/)
scripts/
├── generate-hdr-images.py       # Python script to generate HDR AVIF brand color images
public/
├── models/beerpong.glb          # 3D beer pong table model
├── sponsors/                    # Sponsor logos
└── *.webp, *.jpeg               # Event photos, avatars, logo
```

## Routes

| Path | Component | Description |
|------|-----------|-------------|
| `/` | `HomePage` | Landing page with all sections |
| `/play` | `Play` | Team code entry |
| `/play/dashboard` | `Dashboard` | Team match dashboard |
| `/play/match/:matchId` | `MatchPage` | Individual match view |
| `/scoreboard` | `Scoreboard` | Public scoreboard |
| `/admin` | `AdminPage` | Admin panel (passphrase-gated) |
| `/display` | `DisplayPage` | Chrome-free display mode (no navbar/footer) |

## Architecture Conventions

### Context Pattern
Contexts use a split-file pattern: definition in `*ContextDef.ts` (createContext + types), provider in `*Context.tsx`, and consumer hook in `use*.ts`. This avoids circular imports.

### Component Organization
- **common/**: Shared, reusable components
- **sections/**: Landing page sections (each is a self-contained block)
- **layout/**: App-wide layout components (Navbar, Footer)
- **ui/**: Low-level UI primitives
- **pages/**: Route-level components; admin pages are nested under `pages/admin/`

### Styling
- Tailwind CSS with OKLCH color tokens defined as CSS custom properties in `index.css`
- Theme utility functions in `lib/theme-utils.ts` (use `themeText()`, `themeBg()`, `themeBorder()` for theme-aware classes)
- `cn()` from `lib/utils.ts` for merging Tailwind classes (clsx + tailwind-merge)
- Brand colors have three tiers: sRGB (base), P3 (wide-gamut), and HDR (high dynamic range) via `@media` queries
- HDR text/background effects use PQ-encoded AVIF tile images with CSS `background-clip: text`
- Two background variants: "fluid" (red brand, custom fluid bg) and "framer" (blue brand, iframe bg)
- Display font: "Irish Grover" (serif); body font: "Inter" (sans-serif)

### Path Alias
`@/` maps to `./src/` — configured in both `tsconfig.json` and `vite.config.ts`.

### Lazy Loading
Heavy components (VenueMap, TicketsComingSoon, admin pages, play pages) use `React.lazy()` with `<Suspense>` fallbacks. The `<ErrorBoundary>` component wraps sections that use Three.js or Mapbox to prevent rendering failures from crashing the app.

### Tournament Engine
The core tournament logic is in `lib/tournament-engine.ts`:
- **Swiss pairing** with backtracking to avoid rematches, grouped by win count
- **Knockout bracket** generation (QF/SF/Final) with proper seeding (1 vs 8 half, 2 vs opposite half)
- **Rankings** using: 1) wins desc, 2) Buchholz (opponent wins) desc, 3) total cups hit desc
- Designed for 32 teams, 7 Swiss rounds, top 8 to knockout

### Database (Supabase)
Three tables: `teams`, `matches`, `tournament`. Types are in `lib/database.types.ts`.
- Teams have a 6-character code (3 letters + 3 digits) for player access
- Matches track round, scores, winner/loser, table number, and confirmation status
- Tournament tracks current round, total rounds, and status
- RPC functions: `register_team`, `verify_admin_code`

### Environment Variables
Required in `.env` (not committed):
```
VITE_SUPABASE_URL=...
VITE_SUPABASE_ANON_KEY=...
VITE_MAPBOX_TOKEN=...
```

## Testing

Tests use **Vitest** with Node environment. Test files are co-located with source (e.g., `tournament-engine.test.ts` next to `tournament-engine.ts`). Run with `npm test`.

The tournament engine has comprehensive tests covering Swiss pairing (no rematches, bye distribution, same-wins preference), knockout bracket seeding, advancement, rankings with Buchholz tiebreaker, and full end-to-end tournament simulation.

## CI/CD

GitHub Actions workflow (`.github/workflows/deploy.yml`):
1. Runs on push to `main` or manual dispatch
2. `npm ci` → `npm run lint` → `npm run build`
3. Copies `dist/index.html` to `dist/404.html` (SPA fallback for GitHub Pages)
4. Deploys to GitHub Pages

Secrets needed: `VITE_MAPBOX_TOKEN`, `VITE_SUPABASE_URL`, `VITE_SUPABASE_ANON_KEY`

## Code Style

- **Prettier**: semicolons, single quotes, trailing commas, 2-space indent, 100 char print width
- **ESLint**: TypeScript strict, React hooks rules, React Refresh rules
- **TypeScript**: strict mode, `readonly` on data interfaces, `as const` assertions on constant objects
- All UI text is in Swedish
- Barrel exports via `components/index.ts` for common components
- Build output is chunked by vendor: three.js, mapbox, motion, react (configured in `vite.config.ts`)
